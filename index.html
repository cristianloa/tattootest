<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Tatuajes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script>
    // Configuración de Tailwind para habilitar modo oscuro
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <style>
    /* Ocultar el texto por defecto del input file y personalizar el botón */
    input[type="file"] {
      display: none;
    }
    .custom-file-upload {
      display: inline-block;
      padding: 6px 12px sm:p-8 sm:px-16;
      background-color: #e5e7eb;
      color: #111827;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: transform 0.2s ease-in-out, background-color 0.2s;
      font-size: 0.875rem sm:text-base;
    }
    .dark .custom-file-upload {
      background-color: #4b5563;
      color: #f3f4f6;
    }
    .custom-file-upload:hover {
      background-color: #d1d5db;
      transform: scale(1.05);
    }
    .dark .custom-file-upload:hover {
      background-color: #6b7280;
      transform: scale(1.05);
    }
    /* Estilo para botones de ajuste */
    .adjust-button {
      padding: 4px 8px sm:px-3 sm:py-2;
      font-size: 0.75rem sm:text-sm;
      min-width: 32px;
      text-align: center;
    }
    /* Estilo para botones con animación */
    .animated-button {
      transition: transform 0.2s ease-in-out, background-color 0.2s;
    }
    .animated-button:hover {
      transform: scale(1.05);
    }
    /* Estilo para botón flotante */
    #clearButton {
      position: fixed;
      bottom: 8px;
      right: 8px;
      z-index: 50;
      padding: 6px 10px;
      font-size: 0.75rem;
    }
    @media (min-width: 640px) {
      #clearButton {
        bottom: 20px;
        right: 20px;
        padding: 8px 12px;
        font-size: 0.875rem;
      }
    }
    /* Estilo para texto introductorio en el lienzo */
    #introText {
      animation: pulse 2s infinite ease-in-out;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.02); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }
    /* Sticky controls en móvil */
    @media (max-width: 639px) {
      #customizationStep {
        position: sticky;
        top: 0;
        z-index: 10;
      }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-2 sm:p-4">
  <!-- Contenedor principal con ancho completo -->
  <div class="container mx-auto w-full flex flex-col lg:flex-row gap-2 sm:gap-4">
    <!-- Pantalla 1: Selección de archivos -->
    <div id="screen1" class="w-full lg:w-1/4 mx-auto max-w-[400px] lg:max-w-none flex flex-col gap-4 sm:gap-6">
      <!-- Toggle para modo oscuro -->
      <div class="flex justify-end">
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="darkModeToggle" class="sr-only peer">
          <div class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-orange-500 dark:bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 sm:after:h-5 sm:after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
          <span class="ml-2 text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-300">Modo Oscuro</span>
        </label>
      </div>

      <!-- Personalización - Pantalla 1 -->
      <div class="bg-white dark:bg-gray-900 p-4 sm:p-6 rounded-lg shadow-lg w-full">
        <h1 class="text-xl sm:text-2xl font-bold mb-4 text-center text-gray-900 dark:text-gray-100">¡Selecciona tus Imágenes!</h1>
        
        <!-- Input para subir la fotografía del usuario -->
        <div class="mb-4">
          <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Sube tu foto:</label>
          <label for="photoInput" class="custom-file-upload mt-1">
            <i class="fas fa-camera mr-1 sm:mr-2"></i> ¡Elige tu Foto!
          </label>
          <input type="file" id="photoInput" accept="image/*">
        </div>
        
        <!-- Input para subir el diseño del tatuaje -->
        <div class="mb-4">
          <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Sube tu diseño:</label>
          <label for="tattooInput" class="custom-file-upload mt-1">
            <i class="fas fa-paint-brush mr-1 sm:mr-2"></i> ¡Carga tu Diseño!
          </label>
          <input type="file" id="tattooInput" accept="image/*">
        </div>
        
        <!-- Botón para continuar -->
        <div class="flex justify-center">
          <button id="nextButton" class="animated-button bg-orange-500 dark:bg-orange-600 text-white py-1 px-2 sm:py-2 sm:px-4 rounded hover:bg-orange-600 dark:hover:bg-orange-700 flex items-center justify-center w-full max-w-[200px] sm:max-w-xs text-xs sm:text-sm">
            <i class="fas fa-arrow-right mr-1 sm:mr-2"></i> ¡Continuar a Editar!
          </button>
        </div>
      </div>
    </div>

    <!-- Pantalla 2: Edición del diseño -->
    <div id="screen2" class="w-full lg:w-1/4 mx-auto max-w-[400px] lg:max-w-none flex flex-col gap-4 sm:gap-6 hidden">
      <!-- Botón para regresar -->
      <div class="flex justify-start">
        <button id="backButton" class="animated-button bg-gray-500 dark:bg-gray-600 text-white py-1 px-2 sm:py-2 sm:px-4 rounded hover:bg-gray-600 dark:hover:bg-gray-700 flex items-center text-xs sm:text-sm">
          <i class="fas fa-arrow-left mr-1 sm:mr-2"></i> Regresar
        </button>
      </div>

      <!-- Personalización - Pantalla 2 -->
      <div id="customizationStep" class="bg-white dark:bg-gray-900 p-4 sm:p-6 rounded-lg shadow-lg w-full">
        <h1 class="text-xl sm:text-2xl font-bold mb-4 text-center text-gray-900 dark:text-gray-100">¡Edita tu Tatuaje!</h1>
        
        <!-- Checkboxes para quitar fondo y sombra -->
        <div class="mb-4 flex flex-wrap gap-4">
          <label class="flex items-center text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">
            <input type="checkbox" id="removeBgCheck" class="mr-2 h-4 w-4 text-orange-500 focus:ring-orange-500 border-gray-300 dark:border-gray-600 rounded">
            Quitar fondo
          </label>
          <label class="flex items-center text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">
            <input type="checkbox" id="shadowCheck" class="mr-2 h-4 w-4 text-orange-500 focus:ring-orange-500 border-gray-300 dark:border-gray-600 rounded">
            Añadir sombra
          </label>
        </div>
        
        <!-- Controles de ajuste en cuadrícula -->
        <div class="grid grid-cols-2 gap-2 sm:gap-4 mb-4">
          <!-- Tamaño -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Tamaño: <span id="sizeValue" class="text-gray-500 dark:text-gray-400">100%</span></label>
            <div class="flex mt-1">
              <button id="sizeMinus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-l-md hover:bg-gray-300 dark:hover:bg-gray-600">-</button>
              <button id="sizePlus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-600">+</button>
            </div>
          </div>
          
          <!-- Ancho -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Ancho: <span id="widthValue" class="text-gray-500 dark:text-gray-400">100%</span></label>
            <div class="flex mt-1">
              <button id="widthMinus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-l-md hover:bg-gray-300 dark:hover:bg-gray-600">-</button>
              <button id="widthPlus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-600">+</button>
            </div>
          </div>
          
          <!-- Alto -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Alto: <span id="heightValue" class="text-gray-500 dark:text-gray-400">100%</span></label>
            <div class="flex mt-1">
              <button id="heightMinus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-l-md hover:bg-gray-300 dark:hover:bg-gray-600">-</button>
              <button id="heightPlus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-600">+</button>
            </div>
          </div>
          
          <!-- Rotación -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Rotar: <span id="rotationValue" class="text-gray-500 dark:text-gray-400">0°</span></label>
            <div class="flex mt-1">
              <button id="rotationMinus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-l-md hover:bg-gray-300 dark:hover:bg-gray-600">-</button>
              <button id="rotationPlus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-600">+</button>
            </div>
          </div>
          
          <!-- Opacidad -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Opacidad: <span id="opacityValue" class="text-gray-500 dark:text-gray-400">100%</span></label>
            <div class="flex mt-1">
              <button id="opacityMinus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-l-md hover:bg-gray-300 dark:hover:bg-gray-600">-</button>
              <button id="opacityPlus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-600">+</button>
            </div>
          </div>
          
          <!-- Brillo -->
          <div>
            <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300">Brillo: <span id="brightnessValue" class="text-gray-500 dark:text-gray-400">100%</span></label>
            <div class="flex mt-1">
              <button id="brightnessMinus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-l-md hover:bg-gray-300 dark:hover:bg-gray-600">-</button>
              <button id="brightnessPlus" class="adjust-button bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-r-md hover:bg-gray-300 dark:hover:bg-gray-600">+</button>
            </div>
          </div>
        </div>
        
        <!-- Botón de exportación -->
        <div class="flex justify-center">
          <button id="exportButton" class="animated-button bg-orange-500 dark:bg-orange-600 text-white py-1 px-2 sm:py-2 sm:px-4 rounded hover:bg-orange-600 dark:hover:bg-orange-700 flex items-center justify-center w-full max-w-[200px] sm:max-w-xs text-xs sm:text-sm">
            <i class="fas fa-download mr-1 sm:mr-2"></i> ¡Guarda tu Obra!
          </button>
        </div>
      </div>
    </div>
    
    <!-- Columna 2: Contenedor para el lienzo (75%) -->
    <div class="w-full lg:w-3/4 flex justify-center relative">
      <div id="canvasContainer" class="bg-white dark:bg-gray-900 rounded-lg shadow-lg p-2 sm:p-4 w-full max-w-[400px] sm:max-w-[600px] lg:max-w-[800px] aspect-square relative">
        <!-- Texto introductorio -->
        <div id="introText" class="absolute inset-0 flex items-center justify-center text-center text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 dark:text-orange-500 hidden">
          ¡Crea tu Tatuaje Personalizado!
        </div>
      </div>
      <!-- Botón flotante para limpiar diseño -->
      <button id="clearButton" class="animated-button bg-red-500 dark:bg-red-600 text-white rounded-full hover:bg-red-600 dark:hover:bg-red-700 flex items-center justify-center">
        <i class="fas fa-trash mr-1 sm:mr-2"></i> ¡Borra Todo!
      </button>
    </div>
  </div>

  <script>
    let photoImg, tattooImg, processedTattooImg;
    let tattooX, tattooY; // Posición del tatuaje
    let tattooWidth, tattooHeight; // Dimensiones del tatuaje
    let isDragging = false; // Estado de arrastre
    let offsetX, offsetY; // Desplazamiento para arrastre
    let tattooScale = 1.0; // Escala base del tatuaje
    let widthScale = 1.0; // Escala de ancho
    let heightScale = 1.0; // Escala de alto
    let rotation = 0; // Rotación en grados
    let opacity = 1.0; // Opacidad del tatuaje
    let brightness = 1.0; // Brillo del tatuaje
    let applyShadow = false; // Estado de la sombra
    let removeBg = false; // Estado del checkbox de fondo
    let canvasSize; // Tamaño dinámico del lienzo

    function preload() {
      // Cargar imágenes cuando se suben
      const photoInput = document.getElementById('photoInput');
      const tattooInput = document.getElementById('tattooInput');
      const removeBgCheck = document.getElementById('removeBgCheck');

      photoInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          photoImg = loadImage(URL.createObjectURL(file), () => {
            // Ajustar lienzo al tamaño original de la foto
            adjustCanvasSize();
          });
        }
      });

      tattooInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          tattooImg = loadImage(URL.createObjectURL(file), () => {
            // Procesar la imagen inicial
            processTattooImage();
            // Inicializar posición y tamaño original del tatuaje
            tattooWidth = tattooImg.width * tattooScale * widthScale;
            tattooHeight = tattooImg.height * tattooScale * heightScale;
            tattooX = (canvasSize - tattooWidth) / 2;
            tattooY = (canvasSize - tattooHeight) / 2;
          });
        }
      });

      // Actualizar estado de quitar fondo
      removeBgCheck.addEventListener('change', (event) => {
        removeBg = event.target.checked;
        if (tattooImg) {
          processTattooImage();
          // Recalcular dimensiones
          tattooWidth = tattooImg.width * tattooScale * widthScale;
          tattooHeight = tattooImg.height * tattooScale * heightScale;
          tattooX = constrain(tattooX, 0, canvasSize - tattooWidth);
          tattooY = constrain(tattooY, 0, canvasSize - tattooHeight);
        }
      });
    }

    function processTattooImage() {
      if (!tattooImg) return;

      // Crear una copia de la imagen del tatuaje
      processedTattooImg = createGraphics(tattooImg.width, tattooImg.height);
      processedTattooImg.image(tattooImg, 0, 0);

      if (!removeBg) {
        processedTattooImg = tattooImg; // Usar imagen original
      } else {
        // Aplicar eliminación de fondo con umbral fijo
        processedTattooImg.loadPixels();
        let threshold = 200;
        for (let i = 0; i < processedTattooImg.pixels.length; i += 4) {
          let r = processedTattooImg.pixels[i];
          let g = processedTattooImg.pixels[i + 1];
          let b = processedTattooImg.pixels[i + 2];
          if (r > threshold && g > threshold && b > threshold) {
            processedTattooImg.pixels[i + 3] = 0; // Hacer transparente
          }
        }
        processedTattooImg.updatePixels();
      }

      // Aplicar brillo
      if (brightness !== 1.0) {
        processedTattooImg.loadPixels();
        for (let i = 0; i < processedTattooImg.pixels.length; i += 4) {
          processedTattooImg.pixels[i] = constrain(processedTattooImg.pixels[i] * brightness, 0, 255);
          processedTattooImg.pixels[i + 1] = constrain(processedTattooImg.pixels[i + 1] * brightness, 0, 255);
          processedTattooImg.pixels[i + 2] = constrain(processedTattooImg.pixels[i + 2] * brightness, 0, 255);
        }
        processedTattooImg.updatePixels();
      }
    }

    function adjustCanvasSize() {
      // Ajustar el tamaño del lienzo según la imagen de fondo
      if (photoImg) {
        canvasSize = Math.min(windowWidth - 32, Math.max(photoImg.width, photoImg.height, 400));
        if (windowWidth >= 640 && windowWidth < 1024) {
          canvasSize = Math.min(canvasSize, 600);
        } else if (windowWidth >= 1024) {
          canvasSize = Math.min(canvasSize, 800);
        }
        resizeCanvas(canvasSize, canvasSize);
      } else {
        canvasSize = windowWidth < 640 ? Math.min(windowWidth - 32, 400) : windowWidth < 1024 ? 600 : 800;
        resizeCanvas(canvasSize, canvasSize);
      }
    }

    function setup() {
      // Establecer tamaño inicial del lienzo
      canvasSize = windowWidth < 640 ? Math.min(windowWidth - 32, 400) : windowWidth < 1024 ? 600 : 800;
      let canvas = createCanvas(canvasSize, canvasSize);
      canvas.parent('canvasContainer');

      // Ajustar lienzo al cambiar tamaño de ventana
      windowResized = function() {
        adjustCanvasSize();
        if (tattooImg) {
          tattooWidth = tattooImg.width * tattooScale * widthScale;
          tattooHeight = tattooImg.height * tattooScale * heightScale;
          tattooX = constrain(tattooX, 0, canvasSize - tattooWidth);
          tattooY = constrain(tattooY, 0, canvasSize - tattooHeight);
        }
      };

      // Toggle para modo oscuro
      const darkModeToggle = document.getElementById('darkModeToggle');
      darkModeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('dark');
      });

      // Botón para continuar a la pantalla de edición
      const nextButton = document.getElementById('nextButton');
      nextButton.addEventListener('click', () => {
        if (!photoImg || !tattooImg) {
          alert('Por favor, sube tanto una fotografía como un diseño antes de continuar.');
          return;
        }
        document.getElementById('screen1').classList.add('hidden');
        document.getElementById('screen2').classList.remove('hidden');
      });

      // Botón para regresar a la pantalla de selección
      const backButton = document.getElementById('backButton');
      backButton.addEventListener('click', () => {
        document.getElementById('screen2').classList.add('hidden');
        document.getElementById('screen1').classList.remove('hidden');
      });

      // Botones para ajustar tamaño
      const sizeMinus = document.getElementById('sizeMinus');
      const sizePlus = document.getElementById('sizePlus');
      const sizeValue = document.getElementById('sizeValue');
      sizeMinus.addEventListener('click', () => {
        tattooScale = Math.max(0.5, tattooScale - 0.1);
        sizeValue.textContent = `${Math.round(tattooScale * 100)}%`;
        updateTattooDimensions();
      });
      sizePlus.addEventListener('click', () => {
        tattooScale = Math.min(2.0, tattooScale + 0.1);
        sizeValue.textContent = `${Math.round(tattooScale * 100)}%`;
        updateTattooDimensions();
      });

      // Botones para ajustar ancho
      const widthMinus = document.getElementById('widthMinus');
      const widthPlus = document.getElementById('widthPlus');
      const widthValue = document.getElementById('widthValue');
      widthMinus.addEventListener('click', () => {
        widthScale = Math.max(0.5, widthScale - 0.1);
        widthValue.textContent = `${Math.round(widthScale * 100)}%`;
        updateTattooDimensions();
      });
      widthPlus.addEventListener('click', () => {
        widthScale = Math.min(2.0, widthScale + 0.1);
        widthValue.textContent = `${Math.round(widthScale * 100)}%`;
        updateTattooDimensions();
      });

      // Botones para ajustar alto
      const heightMinus = document.getElementById('heightMinus');
      const heightPlus = document.getElementById('heightPlus');
      const heightValue = document.getElementById('heightValue');
      heightMinus.addEventListener('click', () => {
        heightScale = Math.max(0.5, heightScale - 0.1);
        heightValue.textContent = `${Math.round(heightScale * 100)}%`;
        updateTattooDimensions();
      });
      heightPlus.addEventListener('click', () => {
        heightScale = Math.min(2.0, heightScale + 0.1);
        heightValue.textContent = `${Math.round(heightScale * 100)}%`;
        updateTattooDimensions();
      });

      // Botones para ajustar rotación
      const rotationMinus = document.getElementById('rotationMinus');
      const rotationPlus = document.getElementById('rotationPlus');
      const rotationValue = document.getElementById('rotationValue');
      rotationMinus.addEventListener('click', () => {
        rotation = Math.max(0, rotation - 5);
        rotationValue.textContent = `${Math.round(rotation)}°`;
      });
      rotationPlus.addEventListener('click', () => {
        rotation = Math.min(360, rotation + 5);
        rotationValue.textContent = `${Math.round(rotation)}°`;
      });

      // Botones para ajustar opacidad
      const opacityMinus = document.getElementById('opacityMinus');
      const opacityPlus = document.getElementById('opacityPlus');
      const opacityValue = document.getElementById('opacityValue');
      opacityMinus.addEventListener('click', () => {
        opacity = Math.max(0.1, opacity - 0.1);
        opacityValue.textContent = `${Math.round(opacity * 100)}%`;
      });
      opacityPlus.addEventListener('click', () => {
        opacity = Math.min(1.0, opacity + 0.1);
        opacityValue.textContent = `${Math.round(opacity * 100)}%`;
      });

      // Botones para ajustar brillo
      const brightnessMinus = document.getElementById('brightnessMinus');
      const brightnessPlus = document.getElementById('brightnessPlus');
      const brightnessValue = document.getElementById('brightnessValue');
      brightnessMinus.addEventListener('click', () => {
        brightness = Math.max(0.5, brightness - 0.1);
        brightnessValue.textContent = `${Math.round(brightness * 100)}%`;
        if (tattooImg) {
          processTattooImage(); // Reprocesar para aplicar brillo
        }
      });
      brightnessPlus.addEventListener('click', () => {
        brightness = Math.min(1.5, brightness + 0.1);
        brightnessValue.textContent = `${Math.round(brightness * 100)}%`;
        if (tattooImg) {
          processTattooImage(); // Reprocesar para aplicar brillo
        }
      });

      // Checkbox para sombra
      const shadowCheck = document.getElementById('shadowCheck');
      shadowCheck.addEventListener('change', (event) => {
        applyShadow = event.target.checked;
      });

      // Botón para limpiar diseño
      const clearButton = document.getElementById('clearButton');
      clearButton.addEventListener('click', () => {
        tattooImg = null;
        processedTattooImg = null;
        photoImg = null;
        tattooScale = 1.0;
        widthScale = 1.0;
        heightScale = 1.0;
        rotation = 0;
        opacity = 1.0;
        brightness = 1.0;
        applyShadow = false;
        removeBg = false;
        sizeValue.textContent = '100%';
        widthValue.textContent = '100%';
        heightValue.textContent = '100%';
        rotationValue.textContent = '0°';
        opacityValue.textContent = '100%';
        brightnessValue.textContent = '100%';
        removeBgCheck.checked = false;
        shadowCheck.checked = false;
        document.getElementById('photoInput').value = '';
        document.getElementById('tattooInput').value = '';
        document.getElementById('screen2').classList.add('hidden');
        document.getElementById('screen1').classList.remove('hidden');
      });

      // Exportar imagen
      const exportButton = document.getElementById('exportButton');
      exportButton.addEventListener('click', () => {
        if (!photoImg) {
          alert('Por favor, sube una fotografía antes de guardar.');
          return;
        }
        saveCanvas('simulacion_tatuaje', 'png');
      });

      // Función auxiliar para actualizar dimensiones
      function updateTattooDimensions() {
        if (tattooImg) {
          tattooWidth = tattooImg.width * tattooScale * widthScale;
          tattooHeight = tattooImg.height * tattooScale * heightScale;
          tattooX = constrain(tattooX, 0, canvasSize - tattooWidth);
          tattooY = constrain(tattooY, 0, canvasSize - tattooHeight);
        }
      }
    }

    function draw() {
      background(220);
      
      // Mostrar texto introductorio si no hay imagen
      const introText = document.getElementById('introText');
      if (!photoImg) {
        introText.classList.remove('hidden');
      } else {
        introText.classList.add('hidden');
        // Dibujar la fotografía en su tamaño original, escalado al lienzo
        let photoScale = Math.min(canvasSize / photoImg.width, canvasSize / photoImg.height);
        let photoWidth = photoImg.width * photoScale;
        let photoHeight = photoImg.height * photoScale;
        image(photoImg, (canvasSize - photoWidth) / 2, (canvasSize - photoHeight) / 2, photoWidth, photoHeight);
      }

      // Dibujar el tatuaje con opacidad, brillo y sombra
      if (processedTattooImg) {
        push();
        translate(tattooX + tattooWidth / 2, tattooY + tattooHeight / 2);
        rotate(radians(rotation));
        imageMode(CENTER);
        if (applyShadow) {
          drawingContext.shadowOffsetX = 5;
          drawingContext.shadowOffsetY = 5;
          drawingContext.shadowBlur = 10;
          drawingContext.shadowColor = 'rgba(0, 0, 0, 0.5)';
        }
        drawingContext.globalAlpha = opacity;
        image(processedTattooImg, 0, 0, tattooWidth, tattooHeight);
        drawingContext.globalAlpha = 1.0; // Restaurar opacidad
        drawingContext.shadowBlur = 0; // Restaurar sombra
        pop();
      }
    }

    function mousePressed() {
      // Ajustar la detección de clics considerando la rotación
      if (processedTattooImg && !document.getElementById('screen1').classList.contains('hidden')) {
        return; // No permitir arrastre en la pantalla 1
      }
      if (processedTattooImg) {
        // Transformar las coordenadas del ratón al sistema rotado
        let centerX = tattooX + tattooWidth / 2;
        let centerY = tattooY + tattooHeight / 2;
        let angle = -radians(rotation);
        let mx = mouseX - centerX;
        let my = mouseY - centerY;
        let rotatedX = mx * cos(angle) - my * sin(angle);
        let rotatedY = mx * sin(angle) + my * cos(angle);
        let localX = rotatedX + tattooWidth / 2;
        let localY = rotatedY + tattooHeight / 2;

        if (localX >= 0 && localX <= tattooWidth && localY >= 0 && localY <= tattooHeight) {
          isDragging = true;
          offsetX = mouseX - tattooX;
          offsetY = mouseY - tattooY;
        }
      }
    }

    function mouseDragged() {
      if (isDragging) {
        // Actualizar posición del tatuaje, restringiendo al lienzo
        tattooX = constrain(mouseX - offsetX, 0, canvasSize - tattooWidth);
        tattooY = constrain(mouseY - offsetY, 0, canvasSize - tattooHeight);
      }
    }

    function mouseReleased() {
      isDragging = false;
    }
  </script>
</body>
</html>
